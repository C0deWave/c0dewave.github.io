---
title: "Istio Sidecarì—ì„œ Ambient ëª¨ë“œë¡œ ì „í™˜í•˜ê¸° - Locality ë¼ìš°íŒ…ê¹Œì§€"
date: 2025-12-18 00:00:00 +0900
categories: istio
tags:
  - istio
  - ambient
  - sidecar
  - ztunnel
  - locality
  - kubernetes
  - minikube
excerpt: "Minikube í™˜ê²½ì—ì„œ Istio Sidecar ëª¨ë“œë¥¼ Ambient ëª¨ë“œë¡œ ì „í™˜í•˜ê³ , Locality ê¸°ë°˜ ë¼ìš°íŒ…ì„ ì ìš©í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤."
toc: true
toc_sticky: true
---

## ê°œìš”

Istio 1.23ì—ì„œ Ambient ëª¨ë“œê°€ GA(Generally Available)ë¡œ ìŠ¹ê²©ë˜ë©´ì„œ, ì‚¬ì´ë“œì¹´ ì—†ì´ë„ ì„œë¹„ìŠ¤ ë©”ì‹œì˜ ì´ì ì„ ëˆ„ë¦´ ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê¸€ì—ì„œëŠ” Minikube ë©€í‹° ë…¸ë“œ í™˜ê²½ì—ì„œ Istio ì‚¬ì´ë“œì¹´ ëª¨ë“œë¡œ ì‹œì‘í•˜ì—¬ Ambient ëª¨ë“œë¡œ ì „í™˜í•˜ê³ , Locality ê¸°ë°˜ ë¼ìš°íŒ…ê¹Œì§€ ì ìš©í•˜ëŠ” ì „ì²´ ê³¼ì •ì„ ë‹¤ë£¹ë‹ˆë‹¤.

**ì‹¤ìŠµ ëª©í‘œ:**
1. Minikube ë©€í‹° ë…¸ë“œ í´ëŸ¬ìŠ¤í„° êµ¬ì„±
2. Istio ì‚¬ì´ë“œì¹´ ëª¨ë“œ ì„¤ì¹˜ ë° Bookinfo ì•± ë°°í¬
3. Locality ê¸°ë°˜ ë¼ìš°íŒ… ì„¤ì • ë° í…ŒìŠ¤íŠ¸
4. Ambient ëª¨ë“œë¡œ ë¬´ì¤‘ë‹¨ ì „í™˜
5. Ambient ëª¨ë“œì—ì„œ Locality ë¼ìš°íŒ… ì ìš©

**ì‹¤ìŠµ í™˜ê²½:**
- Minikube v1.35.0
- Kubernetes v1.32.0
- Istio v1.26.6
- 3ê°œ ë…¸ë“œ (ê° 2 CPU, 4GB ë©”ëª¨ë¦¬)

---

## Ambient ëª¨ë“œë€?

### ê¸°ì¡´ ì‚¬ì´ë“œì¹´ ëª¨ë“œì˜ ë¬¸ì œì 

Istioì˜ ê¸°ì¡´ ì‚¬ì´ë“œì¹´ ëª¨ë“œëŠ” ê° Podì— Envoy í”„ë¡ì‹œë¥¼ ì£¼ì…í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì´ ë°©ì‹ì€ ê°•ë ¥í•˜ì§€ë§Œ ëª‡ ê°€ì§€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤:

**1. ë¦¬ì†ŒìŠ¤ ì˜¤ë²„í—¤ë“œ**
- ê° Podë§ˆë‹¤ Envoy í”„ë¡ì‹œê°€ ì‹¤í–‰ë˜ì–´ CPU/ë©”ëª¨ë¦¬ ì†Œë¹„ ì¦ê°€
- ìˆ˜ì²œ ê°œì˜ Podê°€ ìˆëŠ” í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” ìƒë‹¹í•œ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
- ì¼ë°˜ì ìœ¼ë¡œ Podë‹¹ 100-200MB ë©”ëª¨ë¦¬, 0.1-0.5 CPU ì¶”ê°€ ì†Œë¹„

**2. ìš´ì˜ ë³µì¡ì„±**
- ì‚¬ì´ë“œì¹´ ì£¼ì…ì„ ìœ„í•´ Pod ì¬ì‹œì‘ í•„ìš”
- ì‚¬ì´ë“œì¹´ ë²„ì „ ì—…ê·¸ë ˆì´ë“œ ì‹œ ëª¨ë“  Pod ë¡¤ë§ ì—…ë°ì´íŠ¸ í•„ìš”
- ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ í”„ë¡ì‹œì˜ ìƒëª…ì£¼ê¸°ê°€ ê²°í•©ë¨

**3. ë ˆì´í„´ì‹œ ì¦ê°€**
- ëª¨ë“  íŠ¸ë˜í”½ì´ ì‚¬ì´ë“œì¹´ë¥¼ ê±°ì³ì•¼ í•¨
- L4 ìˆ˜ì¤€ì˜ ë‹¨ìˆœ í†µì‹ ì—ë„ L7 í”„ë¡ì‹œ ì˜¤ë²„í—¤ë“œ ë°œìƒ

### Ambient ëª¨ë“œì˜ í•´ê²°ì±…

Ambient ëª¨ë“œëŠ” 2022ë…„ Istio ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì œì•ˆë˜ì–´ 2024ë…„ Istio 1.23ì—ì„œ GA(Generally Available)ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ì•„ì´ë””ì–´: í”„ë¡ì‹œë¥¼ Podì—ì„œ ë¶„ë¦¬**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Node                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Pod A     â”‚  â”‚   Pod B     â”‚  â”‚   Pod C     â”‚         â”‚
â”‚  â”‚  (ì•±ë§Œ)     â”‚  â”‚  (ì•±ë§Œ)     â”‚  â”‚  (ì•±ë§Œ)     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                â”‚                â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                          â”‚                                  â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                   â”‚   Ztunnel   â”‚  â† ë…¸ë“œë‹¹ 1ê°œ (L4 í”„ë¡ì‹œ) â”‚
â”‚                   â”‚  (DaemonSet)â”‚                          â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚            Waypoint Proxy (ì„ íƒì )          â”‚          â”‚
â”‚   â”‚          L7 ê¸°ëŠ¥ í•„ìš” ì‹œì—ë§Œ ë°°í¬           â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ambient ëª¨ë“œì˜ ì¥ì :**
- **ë¦¬ì†ŒìŠ¤ ì ˆì•½**: Podë‹¹ í”„ë¡ì‹œ ëŒ€ì‹  ë…¸ë“œë‹¹ ztunnelë§Œ ì‹¤í–‰
- **ê°„í¸í•œ ìš´ì˜**: Pod ì¬ì‹œì‘ ì—†ì´ ë ˆì´ë¸”ë§Œ ë³€ê²½í•˜ì—¬ ë©”ì‹œ ì°¸ì—¬/íƒˆí‡´
- **ì ì§„ì  L7 ë„ì…**: í•„ìš”í•œ ì„œë¹„ìŠ¤ì—ë§Œ Waypoint Proxy ë°°í¬
- **ë¹ ë¥¸ ì—…ê·¸ë ˆì´ë“œ**: í”„ë¡ì‹œ ì—…ê·¸ë ˆì´ë“œê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ Podì— ì˜í–¥ ì—†ìŒ

**ì£¼ìš” ì»´í¬ë„ŒíŠ¸:**
- **ztunnel**: ë…¸ë“œ ë ˆë²¨ L4 í”„ë¡ì‹œ, mTLS ë° í…”ë ˆë©”íŠ¸ë¦¬ ì²˜ë¦¬
- **waypoint proxy**: ì„œë¹„ìŠ¤ ë ˆë²¨ L7 í”„ë¡ì‹œ, VirtualService/DestinationRule ì²˜ë¦¬
- **istio-cni**: íŠ¸ë˜í”½ ë¦¬ë‹¤ì´ë ‰ì…˜ì„ ìœ„í•œ iptables ê·œì¹™ ì„¤ì •

### Waypoint Proxy: L7 ì„¸ë°€í•œ ì œì–´

Ambient ëª¨ë“œì—ì„œë„ **Waypoint Proxy**ë¥¼ ë°°í¬í•˜ë©´ ì‚¬ì´ë“œì¹´ ëª¨ë“œì™€ ë™ì¼í•œ L7 ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ambient ëª¨ë“œ + Waypoint                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Client  â”‚      â”‚ztunnel  â”‚      â”‚  Waypoint   â”‚             â”‚
â”‚  â”‚   Pod   â”‚â”€â”€â”€â”€â”€â–¶â”‚  (L4)   â”‚â”€â”€â”€â”€â”€â–¶â”‚   Proxy     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   (L7)      â”‚             â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                           â”‚                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                    â”‚  L7 ê¸°ëŠ¥ ì²˜ë¦¬        â”‚                  â”‚ â”‚
â”‚                    â”‚  â€¢ VirtualService    â”‚                  â”‚ â”‚
â”‚                    â”‚  â€¢ DestinationRule   â”‚                  â”‚ â”‚
â”‚                    â”‚  â€¢ í—¤ë” ê¸°ë°˜ ë¼ìš°íŒ…  â”‚                  â”‚ â”‚
â”‚                    â”‚  â€¢ ì¬ì‹œë„/íƒ€ì„ì•„ì›ƒ   â”‚                  â”‚ â”‚
â”‚                    â”‚  â€¢ íŠ¸ë˜í”½ ë¯¸ëŸ¬ë§     â”‚                  â”‚ â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                           â–¼                     â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                                    â”‚   Server    â”‚             â”‚
â”‚                                    â”‚    Pod      â”‚             â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Waypoint Proxy ë°°í¬ ë°©ë²•:**
```bash
# ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— Waypoint ë°°í¬
istioctl waypoint apply -n bookinfo --name reviews-waypoint

# ì„œë¹„ìŠ¤ì— Waypoint ì—°ê²°
kubectl label service reviews -n bookinfo \
  istio.io/use-waypoint=reviews-waypoint
```

**Waypoint Proxyë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ L7 ê¸°ëŠ¥:**

| ê¸°ëŠ¥ | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| **í—¤ë” ê¸°ë°˜ ë¼ìš°íŒ…** | HTTP í—¤ë” ê°’ì— ë”°ë¼ ë¼ìš°íŒ… | `end-user: jason` â†’ v2ë¡œ ë¼ìš°íŒ… |
| **íŠ¸ë˜í”½ ë¶„í• ** | ë²„ì „ë³„ íŠ¸ë˜í”½ ë¹„ìœ¨ ì¡°ì • | v1: 90%, v2: 10% |
| **ì¬ì‹œë„ ì •ì±…** | ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ | 3íšŒ ì¬ì‹œë„, 2ì´ˆ íƒ€ì„ì•„ì›ƒ |
| **ì„œí‚· ë¸Œë ˆì´ì»¤** | ì—°ì† ì—ëŸ¬ ì‹œ íŠ¸ë˜í”½ ì°¨ë‹¨ | 5xx 5íšŒ ì—°ì† ì‹œ 30ì´ˆ ì°¨ë‹¨ |
| **Fault Injection** | ì˜ë„ì  ì§€ì—°/ì—ëŸ¬ ì£¼ì… | 10% ìš”ì²­ì— 5ì´ˆ ì§€ì—° |
| **ìš”ì²­ ë¯¸ëŸ¬ë§** | í”„ë¡œë•ì…˜ íŠ¸ë˜í”½ ë³µì œ | í…ŒìŠ¤íŠ¸ í™˜ê²½ìœ¼ë¡œ ë¯¸ëŸ¬ë§ |

**Waypoint vs Sidecar ì„ íƒ ê¸°ì¤€:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      L7 ê¸°ëŠ¥ì´ í•„ìš”í•œê°€?                     â”‚
â”‚                             â”‚                               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â–¼                             â–¼                â”‚
â”‚           ì•„ë‹ˆì˜¤                          ì˜ˆ                â”‚
â”‚              â”‚                             â”‚                â”‚
â”‚              â–¼                             â–¼                â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚ ztunnelë§Œ ì‚¬ìš© â”‚          â”‚ Waypoint ë°°í¬    â”‚       â”‚
â”‚     â”‚ (L4 mTLSë§Œ)    â”‚          â”‚ (L7 ê¸°ëŠ¥ í™œì„±í™”) â”‚       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â”‚  âœ… ëŒ€ë¶€ë¶„ì˜ ì„œë¹„ìŠ¤ëŠ” L4ë§Œìœ¼ë¡œ ì¶©ë¶„                         â”‚
â”‚  âœ… L7 í•„ìš”í•œ ì„œë¹„ìŠ¤ì—ë§Œ ì„ íƒì ìœ¼ë¡œ Waypoint ë°°í¬           â”‚
â”‚  âœ… ì‚¬ì´ë“œì¹´ ëŒ€ë¹„ ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì  (ì„œë¹„ìŠ¤ë‹¹ 1ê°œ vs Podë‹¹ 1ê°œ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- Ambient ëª¨ë“œëŠ” L4ë§Œ ì§€ì›í•˜ëŠ” ê²ƒì´ ì•„ë‹˜
- Waypoint Proxyë¥¼ í†µí•´ ì‚¬ì´ë“œì¹´ì™€ ë™ì¼í•œ L7 ê¸°ëŠ¥ ì œê³µ
- **ì°¨ì´ì **: ì‚¬ì´ë“œì¹´ëŠ” ëª¨ë“  Podì— í”„ë¡ì‹œ, WaypointëŠ” í•„ìš”í•œ ì„œë¹„ìŠ¤ì—ë§Œ í”„ë¡ì‹œ
- **ì¥ì **: L7 ê¸°ëŠ¥ì´ í•„ìš” ì—†ëŠ” ì„œë¹„ìŠ¤ëŠ” ztunnelë§Œìœ¼ë¡œ ê°€ë³ê²Œ ìš´ì˜

---

## Locality ë¼ìš°íŒ…ì´ë€?

### ë°°ê²½: ë©€í‹° AZ í™˜ê²½ì˜ ë¹„ìš© ë¬¸ì œ

í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ê³ ê°€ìš©ì„±ì„ ìœ„í•´ ì—¬ëŸ¬ ê°€ìš©ì˜ì—­(Availability Zone, AZ)ì— ì›Œí¬ë¡œë“œë¥¼ ë¶„ì‚° ë°°í¬í•©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AWS ap-northeast-2                       â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ap-northeast-2aâ”‚  â”‚  ap-northeast-2bâ”‚  â”‚  ap-northeast-2câ”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Service A â”‚  â”‚  â”‚  â”‚ Service A â”‚  â”‚  â”‚  â”‚ Service A â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Pod 1)  â”‚  â”‚  â”‚  â”‚  (Pod 2)  â”‚  â”‚  â”‚  â”‚  (Pod 3)  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚        â”‚        â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚        â”‚ í˜¸ì¶œ   â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚        â–¼        â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Service B â”‚â—„â”€â”¼â”€â”€â”¼â”€â”€â”‚ Service B â”‚â—„â”€â”¼â”€â”€â”¼â”€â”€â”‚ Service B â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Pod 1)  â”‚  â”‚  â”‚  â”‚  (Pod 2)  â”‚  â”‚  â”‚  â”‚  (Pod 3)  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë¬¸ì œì : Cross-AZ íŠ¸ë˜í”½ ë¹„ìš©**

ê¸°ë³¸ì ìœ¼ë¡œ Kubernetes ServiceëŠ” ë¼ìš´ë“œë¡œë¹ˆìœ¼ë¡œ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— íŠ¸ë˜í”½ì„ ë¶„ì‚°í•©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´:

- **AZ ê°„ ë°ì´í„° ì „ì†¡ ë¹„ìš© ë°œìƒ**: AWS ê¸°ì¤€ $0.01/GB (ê°™ì€ ë¦¬ì „ ë‚´ AZ ê°„)
- **ë ˆì´í„´ì‹œ ì¦ê°€**: ê°™ì€ AZ ë‚´ í†µì‹ ë³´ë‹¤ 1-2ms ì¶”ê°€
- **ëŒ€ê·œëª¨ íŠ¸ë˜í”½ì—ì„œ ë¹„ìš© í­ì¦**: í•˜ë£¨ 1TB íŠ¸ë˜í”½ ì‹œ ì›” $300 ì¶”ê°€ ë¹„ìš©

**ì‹¤ì œ ì‚¬ë¡€:**
> "ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ 100ê°œ, ì¼ì¼ íŠ¸ë˜í”½ 10TBì¸ í™˜ê²½ì—ì„œ Cross-AZ ë¹„ìš©ë§Œ ì›” $3,000 ì´ìƒ ë°œìƒ"

### Locality ë¼ìš°íŒ…ì˜ í•´ê²°ì±…

Locality ë¼ìš°íŒ…ì€ **ê°™ì€ ì§€ì—­(Region)/ê°€ìš©ì˜ì—­(Zone)ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìš°ì„  ì„ íƒ**í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Locality ë¼ìš°íŒ… ì ìš© í›„                  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ap-northeast-2aâ”‚  â”‚  ap-northeast-2bâ”‚  â”‚  ap-northeast-2câ”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Service A â”‚  â”‚  â”‚  â”‚ Service A â”‚  â”‚  â”‚  â”‚ Service A â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Pod 1)  â”‚  â”‚  â”‚  â”‚  (Pod 2)  â”‚  â”‚  â”‚  â”‚  (Pod 3)  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚        â”‚        â”‚  â”‚        â”‚        â”‚  â”‚        â”‚        â”‚ â”‚
â”‚  â”‚        â”‚ 100%   â”‚  â”‚        â”‚ 100%   â”‚  â”‚        â”‚ 100%   â”‚ â”‚
â”‚  â”‚        â–¼        â”‚  â”‚        â–¼        â”‚  â”‚        â–¼        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Service B â”‚  â”‚  â”‚  â”‚ Service B â”‚  â”‚  â”‚  â”‚ Service B â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Pod 1)  â”‚  â”‚  â”‚  â”‚  (Pod 2)  â”‚  â”‚  â”‚  â”‚  (Pod 3)  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  âœ… Cross-AZ íŠ¸ë˜í”½ ìµœì†Œí™” â†’ ë¹„ìš© ì ˆê° + ë ˆì´í„´ì‹œ ê°ì†Œ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Localityì˜ ê³„ì¸µ êµ¬ì¡°:**
```
Region (ap-northeast-2)
  â””â”€â”€ Zone (ap-northeast-2a)
       â””â”€â”€ Sub-zone (ì„ íƒì )
```

**Locality ë¼ìš°íŒ…ì˜ ì¥ì :**
- **ë¹„ìš© ì ˆê°**: Cross-AZ íŠ¸ë˜í”½ ìµœì†Œí™”ë¡œ ë°ì´í„° ì „ì†¡ ë¹„ìš© ì ˆê°
- **ë ˆì´í„´ì‹œ ê°ì†Œ**: ê°™ì€ AZ ë‚´ í†µì‹ ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ í™‰ ìµœì†Œí™”
- **ì¥ì•  ê²©ë¦¬**: Zone ì¥ì•  ì‹œ í•´ë‹¹ Zone ì—”ë“œí¬ì¸íŠ¸ë§Œ ì œì™¸
- **ìë™ Failover**: ê°™ì€ Zoneì— ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ìœ¼ë©´ ë‹¤ë¥¸ Zoneìœ¼ë¡œ ìë™ ë¼ìš°íŒ…

---

## Phase 1: í™˜ê²½ ì¤€ë¹„

### 1-1. Minikube ë©€í‹° ë…¸ë“œ í´ëŸ¬ìŠ¤í„° ìƒì„±

ë¡œì»¬ë¦¬í‹° í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 3ê°œ ë…¸ë“œë¡œ êµ¬ì„±ëœ í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```bash
# ê¸°ì¡´ í´ëŸ¬ìŠ¤í„° ì‚­ì œ
minikube delete

# 3ê°œ ë…¸ë“œë¡œ í´ëŸ¬ìŠ¤í„° ìƒì„±
minikube start --nodes=3 --cpus=2 --memory=4096 --driver=podman
```

**ë…¸ë“œ í™•ì¸:**
```bash
kubectl --context minikube get nodes
```

```
NAME           STATUS   ROLES           AGE   VERSION
minikube       Ready    control-plane   41s   v1.32.0
minikube-m02   Ready    <none>          27s   v1.32.0
minikube-m03   Ready    <none>          15s   v1.32.0
```

### 1-2. Zone ë ˆì´ë¸” ì¶”ê°€

ë¡œì»¬ë¦¬í‹° í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê° ë…¸ë“œì— zone ë ˆì´ë¸”ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```bash
kubectl --context minikube label node minikube topology.kubernetes.io/zone=zone-a
kubectl --context minikube label node minikube-m02 topology.kubernetes.io/zone=zone-b
kubectl --context minikube label node minikube-m03 topology.kubernetes.io/zone=zone-c
```

**í™•ì¸:**
```bash
kubectl --context minikube get nodes -L topology.kubernetes.io/zone
```

```
NAME           STATUS   ROLES           AGE     VERSION   ZONE
minikube       Ready    control-plane   2m16s   v1.32.0   zone-a
minikube-m02   Ready    <none>          2m2s    v1.32.0   zone-b
minikube-m03   Ready    <none>          110s    v1.32.0   zone-c
```

---

## Phase 2: Istio ì„¤ì¹˜ (ì‚¬ì´ë“œì¹´ ëª¨ë“œ)

### 2-1. Istio 1.26.6 ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜

```bash
# Istio ë‹¤ìš´ë¡œë“œ
curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.26.6 sh -

# Default í”„ë¡œíŒŒì¼ë¡œ ì„¤ì¹˜ (ì‚¬ì´ë“œì¹´ ëª¨ë“œ)
./istio-1.26.6/bin/istioctl install --set profile=default -y
```

**ì„¤ì¹˜ ê²°ê³¼:**
```
âœ” Istio core installed â›µï¸
âœ” Istiod installed ğŸ§ 
âœ” Ingress gateways installed ğŸ›¬
âœ” Installation complete
```

**ì„¤ì¹˜ í™•ì¸:**
```bash
kubectl --context minikube get pods -n istio-system
```

```
NAME                                    READY   STATUS    RESTARTS   AGE
istio-ingressgateway-688f6d4c8c-rxnmz   1/1     Running   0          17s
istiod-5756d45dfb-jntcs                 1/1     Running   0          29s
```

**ì£¼ìš” ì»´í¬ë„ŒíŠ¸:**
- **istiod**: ì»¨íŠ¸ë¡¤ í”Œë ˆì¸
- **istio-ingressgateway**: ì¸ê·¸ë ˆìŠ¤ ê²Œì´íŠ¸ì›¨ì´
- ztunnel ì—†ìŒ (ì‚¬ì´ë“œì¹´ ëª¨ë“œ)
- istio-cni-node ì—†ìŒ (ì‚¬ì´ë“œì¹´ ëª¨ë“œ)

---

## Phase 3: Bookinfo ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬

### 3-1. Namespace ìƒì„± ë° ì‚¬ì´ë“œì¹´ ì£¼ì… í™œì„±í™”

```bash
kubectl --context minikube create namespace bookinfo
kubectl --context minikube label namespace bookinfo istio-injection=enabled
```

### 3-2. Bookinfo ì•± ë°°í¬ (Zoneë³„ ë¶„ì‚°)

ë¡œì»¬ë¦¬í‹° í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ reviews ì„œë¹„ìŠ¤ë¥¼ ê° zoneì— ë‹¤ë¥¸ ë²„ì „ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.

**ë°°í¬ ì „ëµ:**
- details, ratings, productpage: ê° zoneì— 1ê°œì”© (ì´ 3ê°œ)
- reviews-v1: zone-aì—ë§Œ ë°°í¬
- reviews-v2: zone-bì—ë§Œ ë°°í¬
- reviews-v3: zone-cì—ë§Œ ë°°í¬

```yaml
# bookinfo-locality.yaml (reviews-v1 ì˜ˆì‹œ)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  namespace: bookinfo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - zone-a
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.20.2
        ports:
        - containerPort: 9080
```

**Pod ë°°í¬ í™•ì¸:**
```bash
kubectl --context minikube get pods -n bookinfo -o wide
```

```
NAME                              READY   STATUS    RESTARTS   AGE   IP           NODE
details-v1-94f89d44f-4zx5j        2/2     Running   0          98s   10.244.2.3   minikube-m03
productpage-v1-6cf65f6dcc-v6dmw   2/2     Running   0          98s   10.244.0.4   minikube
reviews-v1-6f4479b77c-j9ll5       2/2     Running   0          98s   10.244.0.5   minikube
reviews-v2-7bf76c6765-lxpjj       2/2     Running   0          98s   10.244.1.3   minikube-m02
reviews-v3-5847894485-ftsrc       2/2     Running   0          98s   10.244.2.4   minikube-m03
```

**Pod ë¶„í¬:**
- **zone-a (minikube)**: reviews-v1 (ë³„ì  ì—†ìŒ)
- **zone-b (minikube-m02)**: reviews-v2 (ê²€ì€ ë³„)
- **zone-c (minikube-m03)**: reviews-v3 (ë¹¨ê°„ ë³„)

ëª¨ë“  Podê°€ **2/2 Ready** ìƒíƒœë¡œ ì‚¬ì´ë“œì¹´(istio-proxy)ê°€ ì •ìƒ ì£¼ì…ë˜ì—ˆìŠµë‹ˆë‹¤.

---

## Phase 4: Locality ê¸°ë°˜ ë¼ìš°íŒ… ì„¤ì • (ì‚¬ì´ë“œì¹´ ëª¨ë“œ)

### 4-1. DestinationRule ë°°í¬

ì‚¬ì´ë“œì¹´ ëª¨ë“œì—ì„œëŠ” DestinationRuleì„ ì‚¬ìš©í•˜ì—¬ locality ë¼ìš°íŒ…ì„ ì„¤ì •í•©ë‹ˆë‹¤.

```yaml
# locality-destinationrule.yaml
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: reviews-locality
  namespace: bookinfo
spec:
  host: reviews.bookinfo.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      localityLbSetting:
        enabled: true
        distribute:
        - from: "*/zone-a/*"
          to:
            "*/zone-a/*": 100
        - from: "*/zone-b/*"
          to:
            "*/zone-b/*": 100
        - from: "*/zone-c/*"
          to:
            "*/zone-c/*": 100
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 10s
      baseEjectionTime: 30s
```

```bash
kubectl --context minikube apply -f locality-destinationrule.yaml
```

### 4-2. Locality í…ŒìŠ¤íŠ¸

ê° zoneì—ì„œ curl Podë¥¼ ë°°í¬í•˜ê³  í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

```bash
# í…ŒìŠ¤íŠ¸ ê²°ê³¼
=== Locality Test: Sidecar Mode ===

Testing from zone-a:
Expected: reviews-v1 (zone-a) - no stars
  Request 1-10: v1, v1, v1, v1, v1, v1, v1, v1, v1, v1 âœ…

Testing from zone-b:
Expected: reviews-v2 (zone-b) - black stars
  Request 1-10: v2, v2, v2, v2, v2, v2, v2, v2, v2, v2 âœ…
```

ì‚¬ì´ë“œì¹´ ëª¨ë“œì—ì„œëŠ” DestinationRuleì„ í†µí•´ **100% locality ë¼ìš°íŒ…**ì´ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.

---

## Phase 5: Ambient ëª¨ë“œë¡œ ì „í™˜

### 5-1. Istio ì•°ë¹„ì–¸íŠ¸ í”„ë¡œíŒŒì¼ë¡œ ì¬ì„¤ì¹˜

```bash
./istio-1.26.6/bin/istioctl install --set profile=ambient -y
```

**ê²°ê³¼:**
```
âœ” Istio core installed â›µï¸
âœ” Istiod installed ğŸ§ 
âœ” CNI installed ğŸª¢
âœ” Ztunnel installed ğŸ”’
- Pruning removed resources
  Removed apps/v1, Kind=Deployment/istio-ingressgateway.istio-system.
âœ” Installation complete
The ambient profile has been installed successfully, enjoy Istio without sidecars!
```

**ì£¼ìš” ë³€ê²½ì‚¬í•­:**
- âœ… CNI ì„¤ì¹˜ë¨ (istio-cni-node)
- âœ… Ztunnel ì„¤ì¹˜ë¨ (L4 í”„ë¡ì‹œ)
- âŒ Ingress Gateway ì œê±°ë¨

### 5-2. ì•°ë¹„ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ í™•ì¸

```bash
kubectl --context minikube get pods -n istio-system
```

```
NAME                          READY   STATUS    RESTARTS   AGE
istio-cni-node-l8wj4          1/1     Running   0          2m
istio-cni-node-ttldq          1/1     Running   0          2m
istio-cni-node-vhl5f          1/1     Running   0          2m
istiod-5c9ccd6775-twn75       1/1     Running   0          2m
ztunnel-9tthx                 1/1     Running   0          18s
ztunnel-b9zkj                 1/1     Running   0          18s
ztunnel-g4x5z                 1/1     Running   0          18s
```

**ì•°ë¹„ì–¸íŠ¸ ëª¨ë“œ ì•„í‚¤í…ì²˜:**
```
ì‚¬ì´ë“œì¹´ ëª¨ë“œ:
Pod (ì•± + istio-proxy)
  â†“
ê° Podë§ˆë‹¤ í”„ë¡ì‹œ

ì•°ë¹„ì–¸íŠ¸ ëª¨ë“œ:
Pod (ì•±ë§Œ)
  â†“
ztunnel (ë…¸ë“œ ë ˆë²¨ L4 í”„ë¡ì‹œ)
  â†“
waypoint (ì„ íƒì  L7 í”„ë¡ì‹œ)
```

### 5-3. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì „í™˜

```bash
# ì‚¬ì´ë“œì¹´ ì£¼ì… ë¹„í™œì„±í™” + ì•°ë¹„ì–¸íŠ¸ ëª¨ë“œ í™œì„±í™”
kubectl --context minikube label namespace bookinfo \
  istio-injection- \
  istio.io/dataplane-mode=ambient
```

### 5-4. ë¡¤ë§ ì—…ë°ì´íŠ¸ë¡œ ë¬´ì¤‘ë‹¨ ì „í™˜

**ë¡¤ë§ ì—…ë°ì´íŠ¸ ì „ëµ ì„¤ì •:**
```yaml
spec:
  replicas: 4
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # í•­ìƒ ìµœì†Œ replicas ìˆ˜ ìœ ì§€
  template:
    spec:
      containers:
      - readinessProbe:
          httpGet:
            path: /health
            port: 9080
          initialDelaySeconds: 5
          periodSeconds: 5
```

**Pod ì¬ì‹œì‘:**
```bash
kubectl --context minikube rollout restart deployment -n bookinfo
```

**ì „í™˜ ê²°ê³¼:**
- **ì´ ìš”ì²­**: 2540íšŒ
- **ì„±ê³µ**: 2534íšŒ
- **ì„±ê³µë¥ **: **99.76%**
- **ë‹¤ìš´íƒ€ì„**: ì•½ 3ì´ˆ

```bash
kubectl --context minikube get pods -n bookinfo
```

```
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-564778d977-9d4cx       1/1     Running   0          32s
productpage-v1-7859bcd777-4c2xw   1/1     Running   0          18s
reviews-v1-6dd597f4f9-cnlrt       1/1     Running   0          32s
```

ëª¨ë“  Podê°€ **1/1 Ready** ìƒíƒœë¡œ ì‚¬ì´ë“œì¹´ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤!

---

## Phase 6: Ambient ëª¨ë“œì—ì„œ Locality ë¼ìš°íŒ…

### 6-1. ë¬¸ì œ ë°œê²¬: DestinationRuleì´ ë™ì‘í•˜ì§€ ì•ŠìŒ

ì•°ë¹„ì–¸íŠ¸ ëª¨ë“œì—ì„œ ê¸°ì¡´ DestinationRuleë¡œ í…ŒìŠ¤íŠ¸í•˜ë©´:

```bash
=== Locality Test: Ambient Mode (DestinationRule) ===

Testing from zone-a:
Expected: reviews-v1 (zone-a)
  Request 1-10: v1, v2, v1, v2, v1, v2... âŒ (ëœë¤ ë¶„ì‚°)

Testing from zone-b:
Expected: reviews-v2 (zone-b)
  Request 1-10: v1, v2, v1, v2, v1, v2... âŒ (ëœë¤ ë¶„ì‚°)
```

**ì›ì¸:**
- Ztunnelì€ L4 í”„ë¡ì‹œë¡œ DestinationRule(L7)ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ
- Locality ì •ë³´ ì¸ì‹ ë°©ì‹ì´ ë‹¤ë¦„

### 6-2. í•´ê²°ì±…: Kubernetes trafficDistribution ì‚¬ìš©

**Istio 1.23ì˜ ìƒˆë¡œìš´ ë°©ì‹:**

Istio 1.23 Release Notes:
> "Support for the new `Service` field `trafficDistribution`, allowing keeping traffic in local zones/regions."

```yaml
apiVersion: v1
kind: Service
metadata:
  name: reviews
  namespace: bookinfo
spec:
  trafficDistribution: PreferClose  # í•µì‹¬!
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
```

**ì ìš©:**
```bash
kubectl --context minikube patch service reviews -n bookinfo \
  -p '{"spec":{"trafficDistribution":"PreferClose"}}'
```

### 6-3. ì„±ê³µì ì¸ Locality ë¼ìš°íŒ…

```bash
=== Locality Test: Ambient Mode (trafficDistribution) ===

Testing from zone-a (Pod 1):
  Request 1-10: v1, v1, v1, v1, v1, v1, v1, v1, v1, v1 âœ…

Testing from zone-a (Pod 2):
  Request 1-10: v1, v1, v1, v1, v1, v1, v1, v1, v1, v1 âœ…

Testing from zone-b (Pod 1):
  Request 1-10: v2, v2, v2, v2, v2, v2, v2, v2, v2, v2 âœ…

Testing from zone-b (Pod 2):
  Request 1-10: v2, v2, v2, v2, v2, v2, v2, v2, v2, v2 âœ…

=== Summary ===
zone-a â†’ reviews-v1: 20/20 (100%) âœ…
zone-b â†’ reviews-v2: 20/20 (100%) âœ…
```

---

## ì‚¬ì´ë“œì¹´ vs ì•°ë¹„ì–¸íŠ¸ ëª¨ë“œ ë¹„êµ

### Locality ì„¤ì • ë°©ì‹

| í•­ëª© | ì‚¬ì´ë“œì¹´ ëª¨ë“œ | ì•°ë¹„ì–¸íŠ¸ ëª¨ë“œ |
|------|--------------|--------------|
| **ì„¤ì • ë°©ì‹** | DestinationRule | Service.trafficDistribution |
| **ì²˜ë¦¬ ì£¼ì²´** | Envoy (L7) | Ztunnel + Kubernetes (L4) |
| **ì„¸ë°€í•œ ì œì–´** | âœ… ê°€ëŠ¥ (100% ê°•ì œ, ë¹„ìœ¨ ì¡°ì •) | âš ï¸ ì œí•œì  (PreferClose) |
| **ì„¤ì • ë³µì¡ë„** | ë³µì¡ | ê°„ë‹¨ |
| **Kubernetes ë²„ì „** | ë¬´ê´€ | 1.30+ |

### ì•„í‚¤í…ì²˜ ë¹„êµ

| í•­ëª© | ì‚¬ì´ë“œì¹´ ëª¨ë“œ | ì•°ë¹„ì–¸íŠ¸ ëª¨ë“œ |
|------|--------------|--------------|
| **í”„ë¡ì‹œ ìœ„ì¹˜** | ê° Pod ë‚´ë¶€ | ë…¸ë“œ ë ˆë²¨ (ztunnel) |
| **ì»¨í…Œì´ë„ˆ ìˆ˜** | 2 (ì•± + proxy) | 1 (ì•±ë§Œ) |
| **L4 ì²˜ë¦¬** | ì‚¬ì´ë“œì¹´ | ztunnel |
| **L7 ì²˜ë¦¬** | ì‚¬ì´ë“œì¹´ | waypoint (ì„ íƒì ) |
| **ë¦¬ì†ŒìŠ¤ ì‚¬ìš©** | Podë‹¹ í”„ë¡ì‹œ | ë…¸ë“œë‹¹ + waypoint |
| **ë°°í¬ ë³µì¡ë„** | Pod ì¬ì‹œì‘ í•„ìš” | ë ˆì´ë¸”ë§Œ ë³€ê²½ |

### trafficDistribution ì‘ë™ ì›ë¦¬

```
Client Pod â†’ Ztunnel (L4) â†’ Kubernetes Service â†’ Ztunnel (L4) â†’ Server Pod
                           â†‘
                    trafficDistribution: PreferClose
                    (ê°™ì€ zoneì˜ endpoint ìš°ì„  ì„ íƒ)
```

**Kubernetesê°€ Zoneì„ ì¸ì‹í•˜ëŠ” ë°©ë²•:**
1. Nodeì˜ `topology.kubernetes.io/zone` ë ˆì´ë¸” ì½ê¸°
2. Podì˜ `nodeName`ìœ¼ë¡œ zone ë§¤í•‘
3. Endpointsì— zone ì •ë³´ ìë™ ì¶”ê°€
4. `trafficDistribution: PreferClose` ì ìš©

---

## í•µì‹¬ êµí›ˆ

### 1. ê³µì‹ ë¬¸ì„œ í™•ì¸ì˜ ì¤‘ìš”ì„±

Istio ë²„ì „ë³„ Release Notesì—ì„œ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. Ambient ëª¨ë“œì˜ locality ì§€ì›ì€ Istio 1.23 Release Notesì— ëª…ì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤.

### 2. Kubernetes ë„¤ì´í‹°ë¸Œ ê¸°ëŠ¥ í™œìš©

Ambient ëª¨ë“œëŠ” Kubernetesì˜ ë„¤ì´í‹°ë¸Œ ê¸°ëŠ¥(`trafficDistribution`)ì„ í™œìš©í•©ë‹ˆë‹¤. Istio ì „ìš© ê¸°ëŠ¥(DestinationRule)ë³´ë‹¤ í‘œì¤€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ í”Œë«í¼ ë…ë¦½ì ì¸ ì„¤ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### 3. ë¡¤ë§ ì—…ë°ì´íŠ¸ ì „ëµì˜ ì¤‘ìš”ì„±

ì‚¬ì´ë“œì¹´ì—ì„œ ì•°ë¹„ì–¸íŠ¸ë¡œ ì „í™˜ ì‹œ:
- `replicas=1`: ë‹¤ìš´íƒ€ì„ ë¶ˆê°€í”¼
- `replicas=4 + maxUnavailable=0`: ë¬´ì¤‘ë‹¨ ë°°í¬ ê°€ëŠ¥
- `readinessProbe`: ìƒˆ Podê°€ ì¤€ë¹„ëœ í›„ íŠ¸ë˜í”½ ì „í™˜

---

## ê²°ë¡ 

### ì„±ê³µí•œ ê²ƒ

âœ… **Ambient ëª¨ë“œ ì „í™˜**
- ë¬´ì¤‘ë‹¨ ì „í™˜ ë‹¬ì„± (99.76% ê°€ìš©ì„±)
- ì‚¬ì´ë“œì¹´ ì œê±°ë¡œ ë¦¬ì†ŒìŠ¤ ì ˆì•½

âœ… **Locality ë¼ìš°íŒ…**
- `trafficDistribution: PreferClose`ë¡œ 100% ì„±ê³µ
- Minikube í™˜ê²½ì—ì„œë„ ì •ìƒ ë™ì‘

âœ… **ê°„ë‹¨í•œ ì„¤ì •**
- Service í•„ë“œ í•˜ë‚˜ë§Œ ì¶”ê°€
- DestinationRule ë¶ˆí•„ìš”

### ì œì•½ ì‚¬í•­

âš ï¸ **Kubernetes ë²„ì „ ìš”êµ¬**: 1.30+

âš ï¸ **ì„¸ë°€í•œ ì œì–´ ë¶ˆê°€**: PreferCloseë§Œ ì§€ì› (ë¹„ìœ¨ ì¡°ì • ë¶ˆê°€)
- í•´ê²°ì±…: Waypoint Proxy + DestinationRule ì‚¬ìš©

---

## ì°¸ê³  ìë£Œ

### Istio
- [Istio 1.23 Release Notes](https://istio.io/latest/news/releases/1.23.x/announcing-1.23/)
- [Ambient Mode Documentation](https://istio.io/latest/docs/ambient/)
- [Ambient Mode GA Announcement](https://istio.io/latest/blog/2024/ambient-reaches-ga/)

### Kubernetes
- [Service trafficDistribution](https://kubernetes.io/docs/concepts/services-networking/service/#traffic-distribution)
- [Topology Aware Routing](https://kubernetes.io/docs/concepts/services-networking/topology-aware-routing/)
- [Topology Labels](https://kubernetes.io/docs/reference/labels-annotations-taints/#topologykubernetesiozone)
